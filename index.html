<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title>单机版捕鱼达人</title>
		<style type="text/css">
			*{margin: 0;padding: 0;}
			body{text-align: center;background: #000;}
			#playBox{background: #000 url(images/game_bg.jpg) no-repeat;}
		</style>
		<script type="text/javascript" src="src/util.js"></script><!-- 工具 -->
		<script type="text/javascript" src="src/material.js"></script><!-- 素材 -->
		<script type="text/javascript" src="src/Fish.js"></script><!-- 鱼元素 -->
		<script type="text/javascript" src="src/Cannon.js"></script><!-- 炮体元素 -->
		<script type="text/javascript" src="src/Play.js"></script><!-- 组件元素 -->
		<script type="text/javascript" src="src/Bullet.js"></script><!-- 炮弹元素 -->
		<script type="text/javascript">
			//加载
			document.addEventListener('DOMContentLoaded', function(){
				var oBox = document.getElementById('playBox');//游戏盒子
				var gd = oBox.getContext('2d');//用来绘制元素
				var fish_padding = 520;
				var aFish = [];//用来存放鱼元素
				var aBull = [];//用来存放炮弹的

				//加载图片
				util.loadImages(material.img, function(imgs){
					//加载成功
					var fishs = [
						{img : imgs.fish1, w : 55, h : 37, m : 4},
						{img : imgs.fish2, w : 78, h : 64, m : 4},
						{img : imgs.fish3, w : 72, h : 56, m : 4},
						{img : imgs.fish4, w : 77, h : 59, m : 4},
						{img : imgs.fish5, w : 107, h : 122, m : 4}
						// {img : imgs.fish6, w : 105, h : 79, m : 8},
						// {img : imgs.fish7, w : 92, h : 151, m : 6},
						// {img : imgs.fish8, w : 174, h : 126, m : 8},
						// {img : imgs.fish9, w : 166, h : 183, m : 8},
						// {img : imgs.fish10, w : 178, h : 187, m : 6},
						// {img : imgs.shark1, w : 509, h : 270, m : 8},
						// {img : imgs.shark2, w : 516, h : 273, m : 8}
					];


					//点击事件
					document.onclick = function(ev){
						//控制面板的位置
						
						var x1 = ev.pageX - oBox.offsetLeft;
						var y1 = ev.pageY - oBox.offsetTop;
						console.log(x1,y1);
						if(x1 > 87 && x1 < 850 && y1 < oBox.height && y1 > oBox.height - 40){

						}else{
							//旋转炮塔
							var x2 = cannon.x;
							var y2 = cannon.y;
							var x = x1 - x2;
							var y = y1 - y2;
							var a = Math.atan2(y, x);
							cannon.rotate = util.a2d(a) + 90;
						}
					};





					//出现下一只鱼
					function nextFish(){
						setTimeout(function(){
							var _fish = fishs[Math.floor(Math.random() * fishs.length)];
							var oF = new Fish(_fish.img, _fish.w, _fish.h, _fish.m);
							if(Math.random() < 0.5){
								//鱼从左面出来
								oF.x = -fish_padding;
								oF.rotate = Math.random() * 120 - 60;//[-60,60)
							}else{
								//鱼从右面出来
								oF.x = oBox.width + fish_padding;
								oF.rotate = Math.random() * 120 - 240;//[-240,120)
							}
							oF.y = Math.random() * oBox.height;
							aFish.push(oF);
							nextFish();
						}, Math.random() * 500);
					}
					nextFish();
					//定义炮体
					var cannon = new Cannon(imgs.cannon7, 74, 94, 5);
					cannon.x = 512;
					cannon.y = oBox.height - 30;


					//定义组件
					var bottomBar = new Play(imgs.bottomBar, 765, 71);
					bottomBar.x = 468;
					bottomBar.y = oBox.height - 35;
					//定义能量管
					var energyBar = new Play(imgs.energyBar, 213, 19);
					energyBar.x = 735;
					energyBar.y = oBox.height - 17;
					//定义增加按钮
					var cannonMinus = new Play(imgs.cannonMinus, 44, 31);
					cannonMinus.x = 450;
					cannonMinus.y = oBox.height - 20;
					//定义增加按钮
					var cannonPlus = new Play(imgs.cannonPlus, 44, 31);
					cannonPlus.x = 575;
					cannonPlus.y = oBox.height - 20;

					//两个定时器 一个处理换图 一个处理移动绘制
					//绘制
					setInterval(function(){
						//清除画布
						gd.clearRect(0, 0, oBox.width, oBox.height);
						//绘制鱼
						
						for(var i = 0; i < aFish.length; i++){
							if(util.isNotInScreen(oBox.width, oBox.height, aFish[i], fish_padding)){
								aFish.splice(i--, 1);
								continue;
							}
							aFish[i].move();
							aFish[i].draw(gd);
						};
						
						//绘制组件
						bottomBar.draw(gd);
						energyBar.draw(gd);
						cannonMinus.draw(gd);
						cannonPlus.draw(gd);
						//画炮
						cannon.draw(gd);

					}, 16);
					//换图
					setInterval(function(){
						for(var i = 0; i < aFish.length; i++){
							aFish[i].nextFrame();
						}
						cannon.nextFrame();
					}, 150);

				}, function(){
					//加载失败
					alert('加载失败，请刷新重试。');
				});

			}, false);	
		</script>
	</head>
	<body>
		<canvas id="playBox" width="1024" height="700"></canvas>
	</body>
</html>